#!/usr/bin/env bash
ns=fake_aws
curr_dir="$(dirname "$0")"
. $curr_dir/commons.sh

cli() {
  docker run --rm --hostname ${ns}_client --name ${ns}_client --privileged -ti \
    --link ${ns}_s3:${ns}_s3 --link ${ns}_dynamodb:${ns}_dynamodb --link ${ns}_redis:${ns}_redis \
    ${ns}/client $@
}

usage() {
  echo "  Usage:"
  echo "    help"
  echo "    env"
  echo "    images     build"
  echo "    images     delete"
  echo "    containers run"
  echo "    containers kill"
  echo "    data       populate"
  echo "    refresh    all"
  exit 1
}

if [[ $# -lt 1 || "$1" == "help" ]]; then usage; fi

ensure_tools "docker --version"
case "$1 $2" in
  "env ")
    docker-machine env default
    echo export DOCKER_IP=\"$(docker-machine ip default)\"
    echo
    ;;
  "images build")
    set -e
    log_green "  ..building images"
    docker build -t ${ns}/dynamodb src/docker/dynamodb
    docker build -t ${ns}/s3       src/docker/s3
    docker build -t ${ns}/redis    src/docker/redis
    docker build -t ${ns}/client   src/docker/client
    ;;
  "images delete")
    log_green "  ..deleting images"
    docker rmi -f ${ns}/dynamodb ${ns}/s3 ${ns}/redis ${ns}_client
    ;;
  "containers run")
    set -e
    log_green "  ..starting containers"
    docker run --hostname ${ns}_dynamodb --name ${ns}_dynamodb --privileged -p 7777:7777 -td ${ns}/dynamodb -inMemory -port 7777
    docker run --hostname ${ns}_s3       --name ${ns}_s3       --privileged -p 8080:8080 -td ${ns}/s3
    docker run --hostname ${ns}_redis    --name ${ns}_redis    --privileged -p 6379:6379 -td ${ns}/redis
    ;;
  "containers kill")
    set +e
    log_green "  ..stopping containers"
    docker stop  ${ns}_dynamodb ${ns}_s3 ${ns}_redis ${ns}_client
    log_green "  ..removing containers"
    docker rm -f ${ns}_dynamodb ${ns}_s3 ${ns}_redis ${ns}_client
    ;;
  "data populate")
    log_green "  ..creating data"
    # FIXME: hostname endpoints are not resolved
    cli aws dynamodb --endpoint-url http://$(get_docker_ip ${ns}_dynamodb):7777 list-tables
    cli aws s3api create-bucket --bucket dummy_bucket --create-bucket-configuration LocationConstraint=eu-west-1
    cli aws s3 --endpoint-url http://$(get_docker_ip ${ns}_s3):8080 ls s3://dummy
    cli redis-cli -h $(get_docker_ip ${ns}_redis) keys \\*
    cli bash
    ;;
  "refresh all")
    $0 containers kill
    $0 images delete
    set -e
    $0 images build
    $0 containers run
    $0 data populate
    ;;
  *)
    log_bold "  Not a valid command"
    usage
    ;;
esac
